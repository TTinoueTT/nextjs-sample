これは[create-next-app](https://github.com/vercel/next.js/tree/canary/packages/create-next-app)で初期化された[Next.js](https://nextjs.org/)プロジェクトです。

## はじめに

まず、開発サーバーを起動してください：


```bash
npm run dev
# または
yarn dev
# または
pnpm dev
# または
bun dev
```

ブラウザで http://localhost:3000 を開くと、結果を見ることができます。

app/page.tsxを変更することでページの編集を開始できます。ファイルを編集すると、ページは自動的に更新されます。

このプロジェクトでは[`next/font`](https://nextjs.org/docs/basic-features/font-optimization)を使用して、InterというカスタムGoogleフォントを自動的に最適化してロードしています。


## 詳細を学ぶ

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - Next.jsの機能とAPIについて学びます
- [Learn Next.js](https://nextjs.org/learn) - インタラクティブなNext.jsチュートリアルです。

 [Next.js GitHub repository](https://github.com/vercel/next.js/) をチェックして、フィードバックや貢献をお寄せください！

## Vercelでデプロイ

Next.jsアプリをデプロイする最も簡単な方法は、Next.jsのクリエーターが提供する
[Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme)を使用することです。

詳細は[Next.js deployment documentation](https://nextjs.org/docs/deployment) をご覧ください。

## nextjs-sample

### コンテナビルド

ファイルを指定してコンテナをビルド

```bash
docker compose -f docker-compose-local.yml build
```

開発サーバの起動

```bash
docker compose -f docker-compose-local.yml npm run dev
```

## マルチステージビルドについて

### ビルドステージ

ビルドステージでは、アプリケーションのコンパイルやビルドに必要な全てのファイルとツールが含まれます。ここでの主なタスクは以下の通りです：

- __依存関係のインストール__: アプリケーションが依存するライブラリやツールをインストールする
- __ソースコードのコピー__: プロジェクトのソースコードをイメージ内にコピーする。
- __ビルドプロセスの実行__: ソースコードをコンパイルする、ウェブアプリケーションをビルドするなどの作業を行う。

このステージでは、ビルドに必要なツール（コンパイラ、ビルドツール、開発用のライブラリなど）が含まれますが、これらのツールは最終的な実行環境には不要です。

### ビルドステージのみを使用するケース

開発中には、特にアプリケーションのビルドやテストに集中している場合、runtime ステージのコードをコメントアウトしてビルドステージのみを使用することがあります。このアプローチの利点は次のとおりです：

__高速なビルド時間__：runtime ステージを含めないことで、ビルドプロセスが速くなり、開発の迅速化に寄与します。

__デバッグとテストの容易さ__：ビルドステージには、デバッグやテストに必要なツールやファイルが含まれているため、開発中の問題解決が容易になります。

### ランタイムステージ

ランタイムステージでは、アプリケーションを実行するために必要な最小限のファイルや設定のみを含めます。このステージの主な目的は、軽量でセキュアな実行環境を提供することです。

- __新しいベースイメージの選択__: ランタイム用の軽量なベースイメージを選択できる。
- __ビルドステージからのファイルのコピー__: ビルドステージで生成された成果物（ビルドされたアプリケーション、コンパイルされたバイナリなど）をコピーする。
- __本番用依存関係のインストール__: 実行時にのみ必要なライブラリや設定をインストール。
- __実行ユーザーの設定__: セキュリティを強化するために非rootユーザーでアプリケーションを実行

このステージでは、ビルドステージで使われたツールや余分なファイルは除外され、アプリケーションの実行に必要な最小限のコンポーネントのみが含まれます。

### ビルドとランタイムステージを両方使用するケース

一方で、開発プロセスの一部として、実際の本番環境に近い条件でのテストを行いたい場合は、runtime ステージも含めてビルドを行います。これには以下のような利点があります：

__本番環境への準備__：実際の本番環境に近い条件でアプリケーションをテストし、デプロイ前の問題を検出できます。

__環境の一貫性__：開発環境と本番環境との間で環境の差異を最小限に抑えることができます。


### 使い分けのメリット

- __イメージサイズの削減__: 不要なビルドツールや中間ファイルが最終的なイメージに含まれないため、イメージのサイズが小さくなる。
- __セキュリティの向上__: ランタイムイメージに不要なソフトウェアが含まれないため、セキュリティリスクが低減する。
- __ビルドとデプロイの効率化__: ビルドプロセスと実行環境が分離されているため、開発とデプロイメントがより効率的になる。

この方法でDockerfileを設計することで、開発、テスト、本番環境での効率とセキュリティが大幅に向上される。

### 総括

- __開発初期や機能開発中__：runtime ステージをコメントアウトし、ビルドステージのみを使用してビルド時間を短縮し、開発効率を向上させることが一般的です。
- __デプロイ前や本番環境のテスト中__：runtime ステージを含めることで、本番環境に近い条件でのテストを実施し、本番環境へのデプロイに備えます。

最終的なアプローチは、プロジェクトの要件、開発チームのワークフロー、およびデプロイメント戦略に基づいて決定されるべきです。
